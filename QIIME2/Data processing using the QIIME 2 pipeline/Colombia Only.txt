## Processing the “Colombia” dataset using QIIME 2 for downstream analysis ##

#Note that we originally sought to merge two datasets, specifically the Colombia dataset and Texas dataset. Due to challenges in merging the two datasets we proceeded to using only the Colombia dataset. Refer to MICB475_Team4/QIIME2/Data processing using the QIIME 2 pipeline/Merged.txt for code that was run to create some of the input files used below.

#March 21, 2024
#!/bin/bash

#Generating a new table.qza file using the updated metadata file (/prediabetes_wrangled_metadata.tsv.)
# Visualize ASVs stats
qiime feature-table summarize \
  --i-table colombia_table.qza \
  --o-visualization colombia_table2.0.qzv \
  --m-sample-metadata-file /data/metadata_files/prediabetes_wrangled_metadata.tsv

# Navigate to "colombia" directory on local computer and copy colombia_table2.0.qzv
  scp root@<IP>:/data/colombia/colombia_table2.0.qzv . 

#Converting taxonomy.qza file to taxonomy.qzv file
  qiime metadata tabulate \
  --m-input-file colombia_taxonomy.qza \
  --o-visualization colombia_taxonomy.qzv

# Taxonomy barplots
    qiime taxa barplot \
  --i-table colombia_table.qza \
  --i-taxonomy colombia_taxonomy.qza \
  --m-metadata-file /data/metadata_files/prediabetes_wrangled_metadata.tsv \
  --o-visualization colombia_taxa-bar-plots2.0.qzv

# Navigate to "colombia" directory on local computer and copy colombia_taxonomy.qzv and colombia_taxa-bar-plots2.0.qzv
scp root@<IP>:/data/colombia/colombia_taxonomy.qzv . 
scp root@<IP>:/data/colombia/colombia_taxa-bar-plots2.0.qzv . 

#Taxonomy-based filtering
qiime taxa filter-table \
  --i-table colombia_table.qza \
  --i-taxonomy colombia_taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table colombia_table-no-mitochondria-no-chloroplast.qza

qiime feature-table summarize \
  --i-table colombia_table-no-mitochondria-no-chloroplast.qza \
  --o-visualization colombia_table-no-mitochondria-no-chloroplast.qzv \
  --m-sample-metadata-file /data/metadata_files/prediabetes_wrangled_metadata.tsv

# Navigate to "colombia" directory on local computer and copy colombia_taxonomy.qzv and colombia_taxa-bar-plots2.0.qzv
scp root@<IP>:/data/colombia/colombia_table-no-mitochondria-no-chloroplast.qzv . 

# Generate a tree for phylogenetic diversity analyses
qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences colombia_rep-seqs.qza \
  --o-alignment colombia_aligned-rep-seqs.qza \
  --o-masked-alignment colombia_masked-aligned-rep-seqs.qza \
  --o-tree colombia_unrooted-tree.qza \
  --o-rooted-tree colombia_rooted-tree.qza 

# Alpha-rarefaction
qiime diversity alpha-rarefaction \
  --i-table colombia_table-no-mitochondria-no-chloroplast.qza \
  --i-phylogeny colombia_rooted-tree.qza \
  --p-max-depth 109000 \
  --m-metadata-file /data/metadata_files/prediabetes_wrangled_metadata.tsv \
  --o-visualization colombia_alpha-rarefaction.qzv

  # Navigate to "colombia" directory on local computer and copy colombia_alpha-rarefaction.qzv
scp root@<IP>:/data/colombia/colombia_alpha-rarefaction.qzv . 

# By Parvin
