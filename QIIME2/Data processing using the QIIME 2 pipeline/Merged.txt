## Processing the “Colombia” and “Texas” datasets using QIIME 2 for downstream analysis ##

# February 26, 2024
#!/bin/bash

# Create a directory for your project and navigate to it. This is for the Colombia dataset.
mkdir /data/colombia
cd /data/colombia
 
# Since the Colombia dataset has a a manifest file, we will import the dataset and demultiplex using the following code while working directory is 'data/colombia'
qiime tools import \
  --type "SampleData[SequencesWithQuality]" \
  --input-format SingleEndFastqManifestPhred33V2 \
  --input-path /mnt/datasets/project_2/colombia/colombia_manifest.txt \
  --output-path /data/colombia/colombia_demux_seqs.qza

# Create visualization of demultiplexed samples
qiime demux summarize \
  --i-data colombia_demux_seqs.qza \
  --o-visualization colombia_demux_seqs.qzv

# Make directory in home directory on local machine and navigate to this directory
mkdir colombia
cd colombia

# Copy colombia_demux_seqs.qzv
scp root@<IP>:/data/colombia/colombia_demux_seqs.qzv . 

#Import colombia_demux_seqs.qzv into QIIME 2 View and determine appropriate trimming parameters. 

# Determine ASVs with DADA2
qiime dada2 denoise-single \
  --i-demultiplexed-seqs colombia_demux_seqs.qza \
  --p-trim-left 0 \
  --p-trunc-len 230 \
  --o-representative-sequences colombia_rep-seqs.qza \
  --o-table colombia_table.qza \
  --o-denoising-stats colombia_stats.qza

# Visualize ASVs stats
qiime feature-table summarize \
  --i-table colombia_table.qza \
  --o-visualization colombia_table.qzv \
  --m-sample-metadata-file /mnt/datasets/project_2/colombia/colombia_metadata.txt

qiime feature-table tabulate-seqs \
  --i-data colombia_rep-seqs.qza \
  --o-visualization colombia_rep-seqs.qzv

# Copy colombia_table.qzv and colombia_rep-seqs.qzv to local directory 
scp root@<IP>:/data/colombia/colombia_table.qzv .
scp root@<IP>:/data/colombia/colombia_rep-seqs.qzv . 

# Create another directory for your project and navigate to it. This is for the Texas dataset.

mkdir /data/texas
cd /data/texas

# Since the Texas dataset has a a manifest file, we will import the dataset and demultiplex using the following code while working directory is 'data/texas'
qiime tools import \
  --type "SampleData[SequencesWithQuality]" \
  --input-format SingleEndFastqManifestPhred33V2 \
  --input-path /mnt/datasets/project_2/diabetes/texas_manifest.tsv \
  --output-path /data/texas/texas_demux_seqs.qza

  # Create visualization of demultiplexed samples
qiime demux summarize \
  --i-data texas_demux_seqs.qza \
  --o-visualization texas_demux_seqs.qzv

 # Make directory in home directory on local machine and naviagte to this directory
mkdir texas
cd texas

# Copy texas_demux_seqs.qzv
scp root@<IP>:/data/texas/texas_demux_seqs.qzv . 

#Import texas_demux_seqs.qzv into QIIME 2 View and determine appropriate trimming parameters. 

# Determine ASVs with DADA2
qiime dada2 denoise-single \
  --i-demultiplexed-seqs texas_demux_seqs.qza \
  --p-trim-left 0 \
  --p-trunc-len 325 \
  --o-representative-sequences texas_rep-seqs.qza \
  --o-table texas_table.qza \
  --o-denoising-stats texas_stats.qza

  # Visualize ASVs stats
qiime feature-table summarize \
  --i-table texas_table.qza \
  --o-visualization texas_table.qzv \
  --m-sample-metadata-file /mnt/datasets/project_2/diabetes/texas_metadata.tsv
  
qiime feature-table tabulate-seqs \
  --i-data texas_rep-seqs.qza \
  --o-visualization texas_rep-seqs.qzv

# Copy texas_table.qzv and texas_rep-seqs.qzv to local directory 
scp root@<IP>:/data/texas/texas_table.qzv .
scp root@<IP>:/data/texas/texas_rep-seqs.qzv . 

# Create another directory for your project and navigate to it. This directory will be used to merge the two datasets.

mkdir /data/colombia_texas_merged
cd /data/colombia_texas_merged

# Merge Colombia and Texas table files 

qiime feature-table merge \
 --i-tables /data/colombia/colombia_table.qza \
 --i-tables /data/texas/texas_table.qza \
 --o-merged-table merged_table.qza

 # Merge Colombia and Texas representative sequence files 

 qiime feature-table merge-seqs \
 --i-data /data/colombia/colombia_rep-seqs.qza \
 --i-data /data/texas/texas_rep-seqs.qza \
 --o-merged-data merged_rep-seqs.qza

 #To align and tree the representative sequences, use the following command:

 qiime phylogeny align-to-tree-mafft-fasttree \
 --i-sequences merged_rep-seqs.qza \
 --o-alignment merged_aligned-rep-seqs.qza \
 --o-masked-alignment merged_masked-aligned-rep-seqs.qza \
 --o-tree merged_unrooted-tree.qza \
 --o-rooted-tree merged_rooted-tree.qza

# February 27, 2024

# Extract your amplicon of interest from the reference database
#replace the ref-otus.qza with the representative sequence file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-seqs.qza)
#replace primer sequences with your correct sequences
#replace trunc-len with the one you defined in your denoising step
# This is for the Colombia dataset

 qiime feature-classifier extract-reads \
  --i-sequences /mnt/datasets/silva_ref_files/silva-138-99-seqs.qza \
  --p-f-primer GTGCCAGCMGCCGCGGTAA \
  --p-r-primer GGACTACHVGGGTWTCTAAT \
  --p-trunc-len 230 \
  --o-reads colombia_ref-seqs-trimmed.qza

 # Train classifier with your new ref-seq file
# Replace ref-taxonomy.qza with the representative taxonomy file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-tax.qza)
qiime feature-classifier fit-classifier-naive-bayes \
  --i-reference-reads colombia_ref-seqs-trimmed.qza \
  --i-reference-taxonomy /mnt/datasets/silva_ref_files/silva-138-99-tax.qza \
  --o-classifier colombia_classifier.qza

# Use the trained classifier to assign taxonomy to your reads (rep-seqs.qza)
qiime feature-classifier classify-sklearn \
  --i-classifier colombia_classifier.qza \
  --i-reads colombia_rep-seqs.qza \
  --o-classification colombia_taxonomy.qza

March 4, 2024

  # Extract your amplicon of interest from the reference database
#replace the ref-otus.qza with the representative sequence file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-seqs.qza)
#replace primer sequences with your correct sequences
#replace trunc-len with the one you defined in your denoising step
# This is for the Texas dataset

 qiime feature-classifier extract-reads \
  --i-sequences /mnt/datasets/silva_ref_files/silva-138-99-seqs.qza \
  --p-f-primer AGAGTTTGATYMTGGCTCAG \
  --p-r-primer ATTACCGCGGCTGCTGG \
  --p-trunc-len 325 \
  --o-reads texas_ref-seqs-trimmed.qza

  #Realized that we can assign taxonomy without training a classifier therefore proceeded to use the full length classifier.

  # Taxonomic analysis

  qiime feature-classifier classify-sklearn \
  --i-classifier /mnt/datasets/classifiers/silva-138-99-nb-classifier.qza \
  --i-reads merged_rep-seqs.qza \
  --o-classification merged_taxonomy.qza

  qiime metadata tabulate \
  --m-input-file merged_taxonomy.qza \
  --o-visualization merged_taxonomy.qzv

  qiime taxa barplot \
  --i-table merged_table.qza \
  --i-taxonomy merged_taxonomy.qza \
  --m-metadata-file /data/metadata_files/team4_metadata_2.0.tsv \
  --o-visualization merged_taxa-bar-plots.qzv

 # Make directory in home directory on local machine and navigate to this directory
mkdir colombia_texas_merged
cd colombia_texas_merged

# Copy merged_taxonomy.qzv and merged_taxa-bar-plots.qzv to local directory in order to analyze using QIIME 2 view
scp root@<IP>:/data/colombia_texas_merged/merged_taxonomy.qzv . 
scp root@<IP>:/data/colombia_texas_merged/merged_taxa-bar-plots.qzv . 

# Remove eukaryotic sequences from the merged table
 qiime taxa filter-table \
  --i-table merged_table.qza \
  --i-taxonomy merged_taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table merged_table-no-mitochondria-no-chloroplast.qza

# Because taxonomy was not assigned to the Texas dataset, we decided to see what the results would be if we individually ran the analysis for both datasets. We proceeded to generate taxa bar plots for the two datasets independently.

# Train classifier with your new ref-seq file
# Replace ref-taxonomy.qza with the representative taxonomy file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-tax.qza)
qiime feature-classifier fit-classifier-naive-bayes \
  --i-reference-reads texas_ref-seqs-trimmed.qza \
  --i-reference-taxonomy /mnt/datasets/silva_ref_files/silva-138-99-tax.qza \
  --o-classifier texas_classifier.qza

# Use the Texas trained classifier to assign taxonomy to the reads in the Texas dataset (rep-seqs.qza)
qiime feature-classifier classify-sklearn \
  --i-classifier texas_classifier.qza \
  --i-reads texas_rep-seqs.qza \
  --o-classification texas_taxonomy.qza

#Generate a taxa bar plot for the Texas dataset
  qiime taxa barplot \
  --i-table texas_table.qza \
  --i-taxonomy texas_taxonomy.qza \
  --m-metadata-file /data/texas_wrangled_metadata2.0.tsv \
  --o-visualization texas_taxa-bar-plots.qzv

#Generate a taxa bar plot for the Colombia dataset
  qiime taxa barplot \
  --i-table colombia_table.qza \
  --i-taxonomy colombia_taxonomy.qza \
  --m-metadata-file /data/colombia_wrangled_metadata2.0.tsv \
  --o-visualization colombia_taxa-bar-plots.qzv

# March 15, 2024

#Trouble shooting the merging steps. The 16S rDNA sequencing was performed on the V4 hypervariable region for the “Colombia dataset” and for the “Texas dataset”, sequencing was performed on the V1 and V3 regions. Therefore, we decided to train a classifier that used a forward primer for the V1 region and reverse primer for the V4 region.

# Extract your amplicon of interest from the reference database
#replace the ref-otus.qza with the representative sequence file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-seqs.qza)
#replace primer sequences with your correct sequences
#replace trunc-len with the one you defined in your denoising step

 qiime feature-classifier extract-reads \
  --i-sequences /mnt/datasets/silva_ref_files/silva-138-99-seqs.qza \
  --p-f-primer AGAGTTTGATYMTGGCTCAG \
  --p-r-primer GGACTACHVGGGTWTCTAAT \
  --o-reads merged_ref-seqs-trimmed.qza

# March 16, 2024

 # Train classifier with your new ref-seq file
# Replace ref-taxonomy.qza with the representative taxonomy file on the server (e.g. /mnt/datasets/silva_ref_files/silva-138-99-tax.qza)
qiime feature-classifier fit-classifier-naive-bayes \
  --i-reference-reads merged_ref-seqs-trimmed.qza \
  --i-reference-taxonomy /mnt/datasets/silva_ref_files/silva-138-99-tax.qza \
  --o-classifier merged_classifier.qza

# Use the trained classifier to assign taxonomy to your reads (rep-seqs.qza)
qiime feature-classifier classify-sklearn \
  --i-classifier merged_classifier.qza \
  --i-reads merged_rep-seqs.qza \
  --o-classification merged_taxonomy2.0.qza

#Generate a taxa bar plot for the Colombia dataset
  qiime taxa barplot \
  --i-table merged_table.qza \
  --i-taxonomy merged_taxonomy2.0.qza \
  --m-metadata-file /data/metadata_files/team4_metadata_2.0.tsv \
  --o-visualization merged_taxa-bar-plots2.0.qzv

#Copy merged_taxa-bar-plots2.0.qzv to local computer
scp root@10.19.139.169:/data/colombia_texas_merged/merged_taxa-bar-plots2.0.qzv .

#We noticed the taxonomy was only assigned to the Texas dataset to the domain level. Therefore, we sought to merge the taxonomy files we generated for each dataset. 

# March 16, 2024

  #Merging two taxononomy files to create a merged-taxonomy.qza file
  qiime feature-table merge-taxa-data \
  --i-data1 /data/colombia/colombia_taxonomy.qza \
  --i-data2 /data/texas/texas_taxonomy.qza \
  --o-merged-data merged-taxonomy3.0.qza

  #error: Error: QIIME 2 plugin 'feature-table' has no action 'merge-taxa-data'.  Did you mean 'merge-taxa'?

  qiime feature-table merge-taxa \
  --i-data1 /data/colombia/colombia_taxonomy.qza \
  --i-data2 /data/texas/texas_taxonomy.qza \
  --o-merged-data merged-taxonomy3.0.qza

# The above code chunks led to errors. Combining the taxonomy files for the datasets were posing a challenge so we decided to work with only the Colombia dataset after this point. Please refer to MICB475_Team4/QIIME2/Data processing using the QIIME 2 pipeline/Colombia Only.txt for code that was subsequently run.

# By Parvin
